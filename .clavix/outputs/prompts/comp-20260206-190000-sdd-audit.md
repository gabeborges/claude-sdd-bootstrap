---
id: comp-20260206-190000-sdd-audit
depthUsed: comprehensive
timestamp: 2026-02-06T19:00:00Z
executed: false
originalPrompt: "run an SDD audit against all files (claude/ NOT .claude; AGENTS.md, CLAUDE.md) to make sure that SDD is being followed but also (creation of files permissions; tools access; file read access; claude code autonomy policy and more) This needs to be a comprehensive and deep analysis. Get the core files first to understand workflow and rules. Then work on agents. YOu should generate a report with action plan to fix issues/gaps."
---

# Improved Prompt

# SDD & Configuration Compliance Audit

## Objective
Run a comprehensive audit across all Claude Code configuration files to verify:
1. SDD (Specification-Driven Development) artifact flow and rules are correctly enforced
2. File creation/edit/delete permissions are properly scoped
3. Tool access boundaries match CLAUDE.md autonomy policy
4. Agent files correctly inherit and don't contradict root-level rules
5. No security gaps in permission grants or deny patterns

## Scope — Files to Audit
**Root-level (governance):**
- `CLAUDE.md` — project rules, autonomy policy, security, SDD artifact flow
- `AGENTS.md` — agent stop conditions, parallel execution strategy, SDD enforcement

**Configuration directory (`claude/` only — NOT `.claude/`):**
- `claude/settings.local.json` — allow/deny permission patterns
- `claude/autonomy-policy.md` — decision tree, escalation ladder, anti-patterns

**Agent definitions (`claude/agents/`):**
- ALL `.md` files in `claude/agents/` — verify each agent's autonomy section, tool access, file read scope, `@` imports, and stop conditions

## Audit Dimensions

### 1. SDD Compliance
- Verify artifact chain order is enforced: `specs.md → system-design.yaml → db-migration-plan.yaml → tasks.yaml → build-order.yaml`
- Check that "do not create X until Y exists" rules appear in all relevant files
- Confirm no file allows skipping SDD steps
- Verify version safety rules (no cross-version mixing) are present

### 2. Permission & Autonomy Alignment
- Cross-reference `claude/settings.local.json` allow/deny lists against CLAUDE.md § Autonomy & Execution
- Verify every "Always Ask Before" item in CLAUDE.md has a corresponding deny pattern
- Verify every "Always Proceed Without Asking" item has a corresponding allow pattern
- Flag any allow pattern that contradicts Security § Non-negotiable rules
- Check for dangerous command variants missing from deny list (force flags, destructive variants)

### 3. Agent Configuration Consistency
- For each agent in `claude/agents/`:
  - Verify `@` imports reference correct parent files
  - Verify autonomy sections don't grant permissions beyond CLAUDE.md scope
  - Verify tool access lists are appropriate for the agent's role
  - Verify file read/write scope is properly restricted (feature-scoped, not global)
  - Verify stop conditions include SDD gates
  - Flag any agent that can bypass security rules

### 4. Security Boundary Verification
- Confirm Supabase RLS enforcement is mentioned and not bypassed
- Confirm no agent can directly call Supabase from UI layer
- Confirm secrets/credentials rules are propagated to agents
- Confirm `.env` file protections exist in both allow/deny and autonomy policy
- Verify Stripe webhook signature verification is required

### 5. Token/Context Rules
- Verify agents load only their relevant domain splits (not full vision doc)
- Verify file read scopes default to feature-scoped
- Check that large files have explicit "do NOT load unless" gates

## Output Format
Generate a structured report with:
1. **Executive Summary** — overall compliance score, critical findings count
2. **File-by-File Findings** — for each audited file: what's correct, what's missing, what contradicts
3. **Cross-File Consistency Matrix** — where files agree/disagree on the same rule
4. **Action Plan** — prioritized list of fixes:
   - P0 (Security): Issues that could expose secrets or bypass auth
   - P1 (SDD Compliance): Missing artifact chain enforcement
   - P2 (Permissions): Allow/deny gaps or over-broad grants
   - P3 (Consistency): Minor misalignment between files

## Constraints
- Read ALL agent files — do not sample or skip any
- Compare actual file content against CLAUDE.md as source of truth
- Use parallel reads where files are independent
- Flag deprecated syntax (e.g., `Bash(cmd:*)` vs `Bash(cmd *)`) as P2

## Quality Scores
- **Clarity**: 72%
- **Efficiency**: 60%
- **Structure**: 55%
- **Completeness**: 58%
- **Actionability**: 65%
- **Specificity**: 70%
- **Overall**: 63% (needs-improvement)

## Original Prompt
```
run an SDD audit against all files (claude/ NOT .claude; AGENTS.md, CLAUDE.md) to make sure that SDD is being followed but also (creation of files permissions; tools access; file read access; claude code autonomy policy and more) This needs to be a comprehensive and deep analysis. Get the core files first to understand workflow and rules. Then work on agents. YOu should generate a report with action plan to fix issues/gaps.
```

## Alternative Approaches

### 1. Checklist-Driven Audit
Structure the prompt as a flat checklist of ~30 yes/no checks. Best for: Quick pass/fail assessment when you want speed over depth.

### 2. Threat-Model-First Audit
Start from threat scenarios ("What if an agent pushes to main?", "What if secrets leak?") and trace backwards to which files should prevent each threat. Best for: Security-focused teams who want to verify defense-in-depth.

### 3. Diff-Against-Baseline Audit
Define a "golden config" template and diff each file against it. Best for: Teams with multiple repos using the same config pattern who want standardized compliance.

## Validation Checklist
- [ ] Every file in scope was actually read (not skipped)
- [ ] Every CLAUDE.md "Always Ask Before" item maps to a deny pattern
- [ ] Every CLAUDE.md "Always Proceed" item maps to an allow pattern
- [ ] Every agent file was checked for `@` import correctness
- [ ] SDD artifact chain dependencies are enforced in at least 2 files
- [ ] No agent grants itself permissions beyond CLAUDE.md scope
- [ ] Report includes prioritized action items (P0-P3)
- [ ] Cross-file contradictions are explicitly called out

## Edge Cases
- Agent files that have no autonomy section at all (missing vs. empty)
- Permission patterns using deprecated syntax that still function
- Agents that import other agents (transitive permission inheritance)
- Settings that allow broad commands (e.g., `rm *`) but rely on deny overrides for safety
- Files that reference CLAUDE.md sections that have been renamed or restructured
